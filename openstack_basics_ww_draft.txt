All below assume you are logged in and at the Overview page.

The steps below are streamlined. Following them in the order they are laid out will simplify a first-time setup. Performing the steps out of order requires additional menu navigation to put the pieces together.

NETWORKING::

Network, subnet and router setup should be a one-time setup. Security groups can be added as needed for additional permissions and access control. Floating IPs should be set up one per instance and revoked when the instance is destroyed to maximize security.

[main_page_0.png] at start of each?

Creating a Network:
1. Click "Network" - the "Network" fold-out will open
    [networks_000.png]
2. Click "Networks"
    a. the second entry under the "Network" foldout after "Network Topology"
    b. the "Networks" page will open
    c. the "uab-campus" network should already be an entry in the table
    [networks_001.png]
3. Click "+ Create Network" - a dialog box will open
4. Fill out the dialog box
    a. "Network" tab
        [networks_002.png]
        i. Enter a "Network Name"
        ii. Leave "Enable Admin State" checked
        iii. Uncheck "Create Subnet"
            1. will do this as separate step
            2. removes other tabs when unchecked
        iv. Leave the "Availability Zone Hints" box empty
        [networks_003.png]
5. Click "Create"
    [networks_004.png]
    a. Changes to "Network" page.
    ii. Should be a new entry in the table.

Creating a subnet:
1. Click "Network" - the "Network" fold-out will open
    [networks_000.png]
2. Click "Networks"
    a. the second entry under the "Network" foldout after "Network Topology"
    b. the "Networks" page will open
    c. the "uab-campus" network should already be an entry in the table
    d. at least one other entry must be in the table, see "Creating a Network" above
    [networks_004.png]
3. Under the "Actions" column, select the drop-down button in the row corresponding to the network you wish to add a subnet to.
    a. click the triangle, not "Edit Network"
    b. a drop-down menu will appear
    [subnet_002.png]
4. click "Create Subnet" - a dialog box will open
5. Fill out the dialog box
    a. "Subnet" tab
        i. Enter a "Subnet Name"
        ii. Enter a "Network Address"
            1. if this is your only subnet, use 192.168.0.0/24
            2. if this is not your only subnet, choose an ip that will not collide with other subnets
            3. the last two values should be .0.0
            4. the value /24 indicates the entire range can be used, e.g. for 192.168.0.0, all ips from 192.168.0.0 through 192.168.0.255 are available for use on this subnet
            5. 192.168.0.0 is reserved for the subnet itself
        iii. Ensure "IPv4" is selected in the "IP Version" drop-down box
        iv. Leave "Gateway IP" empty
            1. This will select the default, which is the first value in the available range given by the value in (5aii)
            2. If using 192.168.0.0/24, this value will be 192.168.0.1
        v. Leave "Disable Gateway" unchecked
        vi. Click the "Next >>" button to move to the "Subnet Details" tab
        [subnet_003.png]
    b. "Subnet Details" tab
        i. Leave "Enable DHCP" checked
        ii. Enter a range in "Allocation Pools"
            1. if using 192.168.0.0/24 in (5aii), use e.g. 192.168.0.20,192.168.0.100 here
        iii. Leave "DNS Name Servers" empty
        iv. Leave "Host Routes" empty
        [subnet_004.png]
6. Click "Create"
    a. changes to "Overview" page for network the subnet was added to
    [subnet_005.png]
    b. click "Subnets" tab to verify subnet is added to table for this network
    [subnet_006.png]

Creating a router:
ASSUMES A NETWORK AND SUBNET HAVE BEEN CREATED
SEE CREATING A NETWORK
SEE CREATING A SUBNET
1. Click "Network" - the "Network" fold-out will open
    [networks_000.png]
2. Click "Routers" - the "Routers" page will open
    [routers_001.png]
3. Click "+ Create Router" - a dialog box will open
4. Fill out the dialog box
    a. Enter a "Router Name"
    b. Leave "Enable Admin State" checked
    c. Select "uab-campus" in the "External Network" drop down box
    d. Leave the "Availability Zone Hints" box empty
    [routers_002.png]
5. Click "Create Router"
    a. returns to "Routers" page
    b. should have a new entry in the table with the name given in (4a)
    [routers_003.png]
6. Click the name of the new entry under the "Name" column - the router "Overview" page will open
    [routers_004.png]
7. Click the "Interfaces" tab
    [routers_005.png]
8. Click "+ Add Interface" - a dialog box will open
9. Fill out the dialog box
    a. Select an existing network-subnet pair in the "Subnet" drop-down box
    b. If this is your only router on the subnet, leave "IP Address" empty to use the gateway, otherwise select an unused IP Address in the subnet range.
    [routers_006.png]
10. Click "Submit"
    a. changes to "Interfaces" page for router from (5)
    b. Should be a new entry in the table.
    [routers_007.png]

Creating a security group:
NOTE: These instructions are a simple template for creating security groups. They may be applied to SSH, HTTPS, TCP/UDP, etc with some tweaks.
NOTE: Above all the "Principle of Least Privilege" applies to "good practice" in cloud management. It is considered "good practice" to finely divide access rights into very narrowly-defined security groups. Attach only those security groups that are necessary for preparing and using an instance. When those security groups are no longer needed for the instance, they should be revoked as soon as possible.
NOTE: Here we leave the source CIDR very broadly defined for simplicity, in violation of the Principle of Least Privilege. This is only to demonstrate how to use the concept. Ideally, the CIDR would be restricted to a single IP address, e.g. your local machine's IP address.
1. Click "Network" - the "Network" fold-out will open
    [networks_000.png]
2. Click "Security Groups"
    a. the "Security Groups" page will open
    b. the "default" security group should already be an entry in the table
    [security_groups_001.png]
3. Click "+ Create Security Group" - a dialog box will open
4. Fill out the dialog box
    a. Under "Name" enter "ssh"
    b. Leave "Description" empty
    [security_groups_002.png]
5. Click "Create Security Group"
    i. Changes to "Manage Security Group Rules: ssh" page
    ii. Should be an entry for "Egress IPv4" - leave this
    iii. Should be an entry for "Egress IPv6" - leave this
    [security_groups_003.png]
6. Click "+ Add Rule" - a dialog box will open
    i. Select "SSH" in "Rule" drop-down box - the dialog box fields will change
    ii. Leave "Description" empty
    iii. Select "CIDR" in "Remote" drop-down box
    iv. Type "0.0.0.0/0" in "CIDR" box
    [security_groups_004.png]
7. Click "Add"
    i. Returns to "Manage Security Group Rules: ssh" page.
    ii. Should be new entry in the table.
    [security_groups_005.png]

VOLUMES:: (ADVANCED)

Creating a volume:
NOTE: Creating a volume this way is intended for use with persistent or shareable data volumes, and not OS volumes. It may be used to generate OS volumes, but "good practices" are to treat OS volumes as throwaways to be deleted when an instance is destroyed, and data volumes as reusable, shareable and persistent
1. Click the "Volumes" fold-out in the left-hand navigation pane - the fold-out should open
    [volumes_000.png]
2. Click "Volumes" - the "Volumes" page should open
    [volumes_001.png]
3. Click "+ Create Volume" - a dialog box will open
4. Fill out the dialog box
    a. Enter a "Volume Name"
    b. Enter a "Description"
    c. Select "No source, empty volume" in the "Volume Source" drop-down box
    d. Select "__DEFAULT__" in the "Type" drop-down box
    e. Select a size in GB appropriate for your needs
    f. Select "nova" in the "Availability Zone" drop-down box
    g. Select "No group" in the "Group" drop-down box
    [volumes_002.png]
5. Click "Create Volume"
    i. returns to "Volumes" page
    ii. should be a new entry in the table
    [volumes_003.png]

INSTANCES::

Creating a floating (external) IP:
NOTE: Floating IPs are REQUIRED for communication with the internet. These IPs are the externally visible portals for each instance. There are a finite number shared across all users, hence the per-user limitation.
1. Click "Network" - the "Network" fold-out will open
    [network_000.png]
2. Click "Floating IPs" - the "Floating IPs" page will open
    [floating_ips_001.png]
3. Click "Allocate IP to Project" - a dialog box will open
4. Fill out the dialog box
    a. Select "uab-campus" in the "Pool" drop-down box
    b. Leave "Dscription" empty
    c. Leave "DNS Domain" empty
    d. Leave "DNS Name" empty
    [floating_ips_002.png]
5. Click "Allocate IP"
    i. returns to "Floating IPs" page
    ii. should be a new entry in the table
    [floating_ips_003.png]

Creating a key pair:
A KEYPAIR IS REQUIRED FOR SSH ACCESS TO INSTANCES
NOTE: Using a password protected key pair is highly recommended for security reasons. It buys time to invalidate the key pair if an attacker obtains the private key. This is currently only possible to use by uploading a custom public key.
NOTE: Good practice is to only use one key pair per local machine used to access. Do not share private keys between machines you control, and NEVER share private keys with other users. If you need to revoke the private keys, this means more work for you. It also increases the attack surface and risk of compromising your virtual machine. Repeat the steps here to create additional key pairs for additional machines.
1. Click the "Compute" fold-out in the left-hand navigation pane - the fold-out should open
    [key_pairs_000.png]
2. Click "Key Pairs" - the "Key Pairs" page should open
    [key_pairs_001.png]
3. Click "+ Create Key Pair" - a dialog box will open
4. Fill out the dialog box
    a. Enter a "Key Pair Name"
    b. Select "SSH Key" in the "Key Type" drop-down box
    [key_pairs_002.png]
5. Click "+ Create Key Pair"
    i. Opens a browser download file dialog box to download a "*.pem" file
    ii. Download the "*.pem" file. For security reasons this is your only chance to obtain the private key
    iii. Failing to download the "*.pem" file now means needing to create a new key pair.
    [key_pairs_003.png]
    iv. returns to "Key Pairs" page
    v. should be a new entry in the table
    [key_pairs_004.png]
---ALTERNATIVELY
3. Click "Import Public Key" - a dialog box will open
4. Fill out the dialog box
    a. Enter a "Key Pair Name"
    b. Select "SSH Key" in the "Key Type" drop-down box
    c. Click "Browse..." to upload a public key file -OR- copy-paste the content of the file into "Public Key"
    [key_pairs_alt_002.png]
5. Click "+ Create Key Pair"
    iv. returns to "Key Pairs" page
    v. should be a new entry in the table
---
6. To use the key pair from a local machine
    a. `mv` the `*.pem` file to the `.ssh` directory under your home directory
    b. `cd` to the `.ssh` directory under your home directory
    c. `ssh-add *.pem` to add the private key to the ssh keyring
    d. `ssh-add -d *.pem` to remove the key
    [key_pairs_005.png] ANONYMIZE BEFORE UPLOADING!!


Creating an instance:
ASSUMES A NETWORK HAS BEEN CREATED: see "Creating a Network"
ASSUMES A SUBNET HAS BEEN CREATED: see "Creating a Subnet"
ASSUMES A ROUTER HAS BEEN CREATED: see "Creating a Router"
ASSUMES AN SSH SECURITY GROUP HAS BEEN CREATED: see "Creating a Security Group"
ASSUMES ONE OR MORE KEY PAIRS HAVE BEEN CREATED AND REGISTERED LOCALLY: see "Creating a Key Pair"
ASSUMES A FLOATING IP HAS BEEN CREATED: see "Creating a Floating IP"
1. Click the "Compute" fold-out in the left-hand navigation pane - the fold-out should open
2. Click "Instances" - the "Instances" page should open
    [instances_000.png]
3. Click "Launch Instance" - a dialog box with multiple tabs will open
    [instances_001.png]
4. Fill out the dialog box
5. "Details" tab
    a. Enter an "Instance Name"
    b. Enter a "Description"
    c. Select "nova" in the "Availability Zone" drop-down box
    d. Select "1" in the "Count" field
    e. Click "Next >" to move to the "Source" tab
    [instances_002.png]
6. "Source" tab
    a. Select "Image" in the  "Select Boot Source" drop-down box
    b. Select "Yes" under "Create New Volume"
    c. Choose an appropriate "Volume Size" in GB (20GB is more than reasonable for a throw-away linux OS volume)
    d. Select "Yes" or "No" under "Delete Volume on Instance Delete"
        i. "Yes" is a good choice if you plan to reuse the volume for other projects
        ii. "No" is a good choice if you are ok with rebuilding the state for each project
    [instances_003.png]
    e. Pick an image from the list under the "Available" section
        i. Use the search box to help find the image that best suits your needs
        ii. When you find the optimal image, click the button with an up arrow in that image's row
        iii. The image will move to the "Allocated" section above the "Available" section
    f. Click "Next >" to move to the "Flavor" tab
    [instances_004.png]
7. "Flavor" tab
    a. Flavors are pre-defined hardware layouts allocated to the instance. These are like SLURM sbatch/srun flags for jobs on Cheaha HPC.
    b. Pick an instance flavor from the list under the "Available" section
        i. Use the search box to help find the flavor that best suits your needs
        ii. When you find the optimal flavor, click the button with an up arrow in that flavor's row
        iii. The flavor will move to the "Allocated" section above the "Available" section
        NOTE (ADVANCED): If using a GPU flavor, see "Installing GPU Drivers" for required steps to use the GPU(s).
    c. Click "Next >" to move to the "Networks" tab
    [instances_005.png]
8. "Networks" tab
    a. Pick a network from the list under the "Available" section
        i. A network may already be picked in the "Allocated" section, use the down arrow button to remove it if needed
        ii. Use the search box to help find the network that best suits your needs
        iii. When you find the optimal network, click the button with an up arrow in that network's row
        iv. The network will move to the "Allocated" section above the "Available" section
    b. Click "Next >" to move to the "Network Ports" tab
    [instances_006.png]
9. "Network Ports" tab
    a. Leave empty
    b. Click "Next >" to move to the "Security Groups" tab
    [instances_007.png]
10. "Security Groups" tab
    a. Pick the "ssh" security group from the "Available" section
    b. The "default" security group should be in the "Allocated" section
    c. Click "Next >" to move to the "Key Pair" tab
    [instances_008.png]
11. "Key Pair" tab
    a. Pick one or more key pairs from the list under the "Available" section
        i. A key pair may already be picked in the "Allocated" section, use the down arrow button to remove it if needed
        ii. Use the search box to help find the key pair that best suits your needs
        iii. When you find the optimal key pair, click the button with an up arrow in that key pair's row
        iv. The key pair will move to the "Allocated" section above the "Available" section
    b. Click "Next >" to move to the "Configuration" tab
    [instances_009.png]
12. "Configuration" tab
    a. Skip this tab
    b. Click "Next >" to move to the "Server Groups" tab
    [instances_010.png]
12. "Server Groups" tab
    a. Skip this tab
    b. Click "Next >" to move to the "Scheduler Hints" tab
    [instances_011.png]
12. "Scheduler Hints" tab
    a. Skip this tab
    b. Click "Next >" to move to the "Metadata" tab
    [instances_012.png]
12. "Metadata" tab
    a. Skip this tab
    [instances_013.png]
13. Click "Launch Instance" to launch the instance
    i. returns to the "Instances" page
    ii. There should be a new entry in the table
    iii. The instance will take some time to build and boot. When the Status column entry says "Active" please move to the next steps
    [instances_014.png]
    [instances_015.png]
14. Associate Floating IP
    a. In the "Actions" column entry, click the drop-down triangle and select "Associate Floating IP"
    [instances_016.png]
    b. A dialog box will open
    c. Select an IP address in the "IP Address" drop-down box
    d. Select a port in the "Port to be associated" drop-down box
    [instances_017.png]
    e. Click "Associate"
        i. returns to the "Instances" page
15. Attach Volume (ADVANCED)
    a. In the "Actions" column entry, click the drop-down triangle button and select "Attach Volume"
    [instances_018.png]
    b. A dialog box will open
    c. Select a volume in the "Volume ID" drop-down box
    [instances_019.png]
    d. Click "Attach Volume"
    e. See "Preparing Persistent Volumes" for additional steps
16. At this stage you should be able to SSH into your instance from on campus or on the UAB VPN. Note that most images have a default user. Ubuntu images have "ubuntu" and Centos images have "centos".
    a. `ssh ubuntu@<floating ip> -i ~/.ssh/*.pem`
    [instances_020.png]

Preparing Persistent Volumes (ADVANCED):
NOTE these steps can, and probably should be, automated using a shell script.
NOTE steps 5-7 are one-time per volume
NOTE steps 8-14 are one-time per instance
1. Navigate to Compute -> Instances -> <instance name> -> Overview
2. Scroll down to "Volumes Attached" and make note of the <mount> part of "<volume-name> on <mount>" for your attached volume
    [persistent_volumes_000.png]
3. SSH into the instance
4. Verify attached using `sudo fdisk -l | egrep "<mount>"`
    [persistent_volumes_001.png]
5. Format using `sudo fdisk "<mount>"`
    a. You will be in the fdisk utility REPL
    b. Enter "n" to create a new partition
    c. Enter "p" to make it the primary partition
    d. Enter numeral "1" to make it the first partition
    e. Press enter to accept default first sector
    f. Press enter to accept default last sector
    g. Enter "t" to change partition type
    h. Enter numerals "83" to change to Linux type
    i. Enter "p" to display the partition setup, note that the partition is <mount>1 (literally whatever <mount> is followed by the numeral 1 from (5d)). We will call this <pmount>.
    j. Enter "w" to write the setup prepared above
    [persistent_volumes_002.png]
6. Verify the disk is not mounted using `sudo mount | egrep "<mount>".
    a. If there is an output use `sudo umount -l "<mount>"` to unmount the volume.
    [persistent_volumes_003.png]
7. Create the filesystem using `smkfs.ext4 "<pmount>"`
    a. Check the output looks like...
```
mke2fs 1.45.5 (07-Jan-2020)
Could not open /dev/vdb1: Permission denied
ubuntu@my-instance:~$ sudo mkfs.ext4 /dev/vdb1
mke2fs 1.45.5 (07-Jan-2020)
Discarding device blocks: done
Creating filesystem with 26214144 4k blocks and 6553600 inodes
Filesystem UUID: 335704a9-2435-440a-aeea-8ae29438ac64
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000, 7962624, 11239424, 20480000, 23887872

Allocating group tables: done
Writing inode tables: done
Creating journal (131072 blocks): done
Writing superblocks and filesystem accounting information: done
```
    [persistent_volumes_004.png]
8. Obtain the uuid using `sudo blkid | egrep "<pmount>"`. We will call this <uuid>.
    [persistent_volumes_005.png]
9. Create a directory to mount to. A good choice is `sudo mkdir /mnt/<volume-name>`. We will call this <directory>.
10. Mount the volume to the directory using `sudo mount -U <uuid> <directory>`
11. Verify mounted using `df -h | egrep "<pmount>"`
    [persistent_volumes_006.png]
12. Edit the `fstab` file to make mounting persist across restarts.
    a. Edit using `sudo nano /etc/fstab`
    b. Add the following:
```
/dev/disk/by-uuid/<uuid> <directory> auto defaults,nofail 0 3
```
    [persistent_volumes_007.png]
13. Soft reboot the instance and repeat step 11 to verify correct `/etc/fstab`
    [persistent_volumes_008.png]
14. Set access control using
```
sudo apt install acl (or yum install, etc., if not already installed)
sudo setfacl -R -m u:<username>:rwx <directory>
```
    [persistent_volumes_009.png]
15. Verify access controls by touching a test file and listing files in <directory>
    [persistent_volumes_010.png]

Installing GPU Drivers (ADVANCED):
1. add instructions from https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html#ubuntu-lts



1. sudo apt install ubuntu-drivers
2. ubuntu-drivers devices    # shows what driver versions
3. sudo apt install nvidia-driver-470   # <-- for using code
4. sudo apt install nvidia-cuda-toolkit # <-- for developing code
--ALTERNATIVELY instead of (2-3) just use below, but beware the result may change over time
2. sudo ubuntu-drivers autoinstall
